<tool id="mutation_pipeline_multisample" name="SNP Calling Pipeline (Multisample)">

    <description>Mutation Calling pipeline focused on cancer analysis (Multisample mode)</description>

    <requirements>
       <requirement type="set_environment">WRAPPERS</requirement>
       <requirement type="package"></requirement>
    </requirements>

    <command>
     #if str($sample_file) != "":
         python \$WRAPPERS/ctat_mutation_wrapper.py -s "$sample_file"
     #end if

     #if str($tissue_type) != "":
         --tissue_type "$tissue_type"
     #end if
     
     -p "$out_file1"

     --bedoutputname "$bed_path"
     --rnabam "$rna_bam_path"
     --mutation_json "$mutation_json"
     --vvpath "$variant_vcf"
     --vivpath "$variant_initial_vcf"
     --cvpath "$cancer_variant_vcf"
     --ctpath "$cancer_tab"
     --recabpath "$recalibrated_bam"

     #if $output_directory:
         --directory "$output_directory"        
     #end if
    </command>

    <inputs>
      <param name="sample_file" type="text" label="Sample File:"/>
      <param name="reference_genome" type="select" label="Select a reference genome:" default="hg19" help="If your genome of interest is not listed, contact the KCO Galaxy team.">
             <option value="hg19">Hg19</option>
      </param>
      <param name="tissue_type" type="select" label="Select a pathology:" help="If you don't know, select 'General Purpose'">
             <option value="Bladder">Bladder Urothelial Carcinoma</option>
             <option value="Blood-Lymphocyte">Chronic Lymphocytic Leukemia</option>
             <option value="Blood-Myeloid">Acute Myeloid Leukemia</option>
             <option value="Brain-Cerebellum">Medulloblastoma</option>
             <option value="Brain-Glioblastoma-Multiforme">Glioblastoma Multiforme</option>
             <option value="Brain-Lower-Grade-Glioma">Brain Lower Grade Glioma</option>
             <option value="Breast">Breast Invasive Carcinoma</option>
             <option value="Cervix">Cervical Squamous Cell Carcinoma and Endocervical Adenocarcinoma</option>
             <option value="Colon">Colon Adenocarcinoma</option>
             <option value="Head and Neck">Head and Neck Squamous Cell Carcinoma</option>
             <option value="Kidney-Chromophobe">Kidney Chromophobe</option>
             <option value="Kidney-Clear-Cell">Kidney Renal Clear Cell Carcinoma</option>
             <option value="Kidney-Papillary-Cell">Kidney Renal Papillary Cell Carcinoma</option>
             <option value="Liver-Nonviral">Hepatocellular Carcinoma (Secondary to Alcohol and Adiposity)</option>
             <option value="Liver-Viral">Hepatocellular Carcinoma (Viral)</option>
             <option value="Lung-Adenocarcinoma">Lung Adenocarcinoma</option>
             <option value="Lung-Squamous Cell">Lung Squamous Cell Carcinoma</option>
             <option value="Melanoma">Melanoma</option>
             <option value="Other">General purpose</option>
             <option value="Ovary">Ovarian Serous Cystadenocarcinoma</option>
             <option value="Pancreas">Pancreatic Cancer</option>
             <option value="Prostate-Adenocarcinoma">Prostate Adenocarcinoma</option>
             <option value="Rectum">Rectum Adenocarcinoma</option>
             <option value="Skin">Skin Cutaneous Melanoma</option>
             <option value="Stomach">Stomach Adenocarcinoma</option>
             <option value="Thyroid">Thyroid Carcinoma</option>
             <option value="Uterus">Uterine Corpus Endometriod Carcinoma</option>
      </param>
      <param name="output_directory" type="text" label="Output directory name:"/>
    </inputs>

    <outputs>
           <data format="text" name="out_file1" label="track_file"/>
           <data format="bed" name="bed_path" label="Bed_file"/>
           <data format="bam" name="rna_bam_path" label="Bam file"/>
           <data format="json" name="mutation_json" label="mutation_json"/>
           <data format="vcf" name="variant_vcf" label="variant_vcf"/>
           <data format="vcf" name="variant_initial_vcf" label="variant_initial_vcf"/>
           <data format="vcf" name="cancer_variant_vcf" label="cancer_variant_vcf"/>
           <data format="tabular" name="cancer_tab" label="cancer_tab"/>
           <data format="bam" name="recalibrated_bam" label="recalibrated_bam"/>
    </outputs>

    <stdio>
          <exit_code range="2"   level="fatal"   description="Out of Memory" />
          <exit_code range="3:5" level="warning" description="Low disk space" />
          <exit_code range="6:"  level="fatal"   description="Bad input dataset" />
          <exit_code range="99"  level="fatal"   description="Bad input dataset" />
    </stdio>

    <tests>
        <test>
            <param name="sample_file" value="/seq/regev_genome_portal/KCO_TESTING/sample_files/ctat_mutation_galaxy_test.txt" />
            <param name="reference_genome" value="Hg19" />
            <param name="tissue_type" value="Breast" />
            <param name="output_directory" value="/broad/hptmp/ttickle/galaxy_tests/CTAT_mutation" />
            <output name="output" file="/samples/MCF7_abridged/RNASEQ_MUTATION_PREMADE/cancer.vcf" />
        </test>
    </tests>

    <help>
.. class:: warningmark

This service uses the GATK. The GATK is licensed by the Broad Institute and is made available to academic users of this service for non-commercial use only. The full text of the license is available here_. For more information about GATK and full documentation, please visit the GATK website_.


**Instructions to run:**

Before running the pipeline please take note of the following:-

1) Create a directory for results (Eg: /broad/hptmp/[username]/galaxy_work) and give it 777 permission so Galaxy can write your results in the directory.

    - mkdir /broad/hptmp/[username]/galaxy_work

    - chmod -R 777 /broad/hptmp/[username]/galaxy_work

2) If not already on Broad servers, load your data on a Broad server.

3) Create a samples.txt and place it on a Broad server.

This is a **tab delimited file** indicating where your samples are on the server. The columns of the text file should be the sample name, the left fastq/.gz, and the right fastq/.gz. An example of the content of such a file could be:

sample1    /abs/path/to/sample1.R1.fastq.gz    /abs/path/to/sample1.R2.fastq.gz

sample2    /abs/path/to/sample2.R1.fastq.gz    /abs/path/to/sample2.R2.fastq.gz

sample3    /abs/path/to/sample3.R1.fastq.gz    /abs/path/to/sample3.R2.fastq.gz


.. _website: https://www.broadinstitute.org
.. _here: https://www.broadinstitute.org/gatk/about/license.html
    </help>

</tool>
